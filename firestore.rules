rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Bookings collection
    // - Everyone can write (create bookings)
    // - Only logged in users can read, update, delete
    match /bookings/{bookingId} {
      allow read, update, delete: if isAuthenticated();
      allow create: if true;
    }
    
    // ContactMessages collection
    // - Everyone can write (submit contact forms)
    // - Only logged in users can read, update, delete
    match /contactMessages/{messageId} {
      allow read, update, delete: if isAuthenticated();
      allow create: if true;
    }
    
    // Customers collection
    // - Only logged in users can perform all operations
    match /customers/{customerId} {
      allow read, write, update, delete: if isAuthenticated();
    }
    
    // Massages collection
    // - Everyone can read
    // - Only logged in users can write, update, delete
    match /massages/{massageId} {
      allow read: if true;
      allow write, update, delete: if isAuthenticated();
    }
    
    // Treatments collection
    // - Everyone can read
    // - Only logged in users can write, update, delete
    match /treatments/{treatmentId} {
      allow read: if true;
      allow write, update, delete: if isAuthenticated();
    }
    
    // Reviews collection
    // - Everyone can read and create (write reviews)
    // - Only logged in users can update, delete
    match /reviews/{reviewId} {
      allow read, create: if true;
      allow update, delete: if isAuthenticated();
    }
    
    // Gift vouchers collection
    // - Everyone can create (purchase gift vouchers) with validation
    // - Only logged in users can read, update, delete
    match /giftVouchers/{voucherId} {
      allow read, update, delete: if isAuthenticated();
      allow create: if 
        // Status must be 'pending' (security: only webhook can set to 'paid')
        request.resource.data.status == 'pending' &&
        // Amount must be one of the valid options (prevent manipulation)
        // Check if amount is a number and matches one of the valid values
        request.resource.data.amount is number &&
        (request.resource.data.amount == 45.0 ||
         request.resource.data.amount == 60.0 ||
         request.resource.data.amount == 85.0 ||
         request.resource.data.amount == 95.0 ||
         request.resource.data.amount == 115.0) &&
        // Required fields must be present and non-empty
        request.resource.data.purchaserName is string &&
        request.resource.data.purchaserName.size() > 0 &&
        request.resource.data.purchaserEmail is string &&
        request.resource.data.purchaserEmail.size() > 0 &&
        request.resource.data.recipientName is string &&
        request.resource.data.recipientName.size() > 0 &&
        request.resource.data.recipientEmail is string &&
        request.resource.data.recipientEmail.size() > 0 &&
        // paidAt must be null or not set (only webhook can set this after payment)
        (!('paidAt' in request.resource.data) || request.resource.data.paidAt == null) &&
        // paypalOrderId must be empty string or not set (only webhook can set this after payment)
        (!('paypalOrderId' in request.resource.data) || request.resource.data.paypalOrderId == '');
    }
    
    // Closed days collection
    // - Everyone can read (needed for booking form)
    // - Only logged in users can create, update, delete
    match /closedDays/{closedDayId} {
      allow read: if true;
      allow create, update, delete: if isAuthenticated();
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

