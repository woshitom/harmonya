/**
 * Firebase Cloud Function pour envoyer des emails lors de nouvelles réservations
 * 
 * Installation:
 * 1. npm install -g firebase-tools
 * 2. firebase login
 * 3. firebase init functions
 * 4. cd functions && npm install resend
 * 5. firebase functions:config:set resend.api_key="votre-api-key"
 * 6. firebase deploy --only functions
 */

const functions = require('firebase-functions');
const admin = require('firebase-admin');
const { Resend } = require('resend');

admin.initializeApp();

// Initialiser Resend avec la clé API depuis les configs Firebase
const resendApiKey = functions.config().resend?.api_key || process.env.RESEND_API_KEY;
const resend = new Resend(resendApiKey);

// Email de l'administrateur (à remplacer par votre email)
const ADMIN_EMAIL = 'votre-email@example.com';

// Domaine d'envoi (à remplacer par votre domaine vérifié dans Resend)
const FROM_EMAIL = 'Harmonya <noreply@votre-domaine.com>';

/**
 * Fonction déclenchée automatiquement lorsqu'une nouvelle réservation est créée
 */
exports.sendBookingEmail = functions.firestore
  .document('bookings/{bookingId}')
  .onCreate(async (snap, context) => {
    const booking = snap.data();
    const bookingId = context.params.bookingId;
    
    // Formater la date en français
    const dateFormatted = booking.date.toDate().toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Email pour l'administrateur
    try {
      await resend.emails.send({
        from: FROM_EMAIL,
        to: ADMIN_EMAIL,
        subject: `Nouvelle réservation - ${booking.name}`,
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .container { max-width: 600px; margin: 0 auto; padding: 20px; }
              .header { background-color: #6B4423; color: white; padding: 20px; text-align: center; }
              .content { background-color: #F5F1E8; padding: 20px; }
              .info-row { margin: 10px 0; }
              .label { font-weight: bold; color: #6B4423; }
              .footer { text-align: center; margin-top: 20px; color: #666; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>Nouvelle Réservation</h1>
              </div>
              <div class="content">
                <p>Une nouvelle réservation a été reçue :</p>
                <div class="info-row">
                  <span class="label">Nom:</span> ${booking.name}
                </div>
                <div class="info-row">
                  <span class="label">Email:</span> ${booking.email}
                </div>
                <div class="info-row">
                  <span class="label">Téléphone:</span> ${booking.phone}
                </div>
                <div class="info-row">
                  <span class="label">Date:</span> ${dateFormatted}
                </div>
                <div class="info-row">
                  <span class="label">Heure:</span> ${booking.time}
                </div>
                <div class="info-row">
                  <span class="label">Type de massage:</span> ${booking.massageType}
                </div>
                ${booking.notes ? `
                <div class="info-row">
                  <span class="label">Notes:</span> ${booking.notes}
                </div>
                ` : ''}
                <div class="info-row">
                  <span class="label">Statut:</span> ${booking.status}
                </div>
                <div class="info-row">
                  <span class="label">ID Réservation:</span> ${bookingId}
                </div>
              </div>
              <div class="footer">
                <p>Harmonya - Massage & Bien-être</p>
                <p>1 A rue de la poste 67400 ILLKIRCH GRAFFENSTADEN</p>
              </div>
            </div>
          </body>
          </html>
        `,
      });
      
      console.log(`Email admin envoyé avec succès pour la réservation ${bookingId}`);
    } catch (error) {
      console.error(`Erreur lors de l'envoi de l'email admin:`, error);
    }
    
    // Email de confirmation pour le client
    try {
      await resend.emails.send({
        from: FROM_EMAIL,
        to: booking.email,
        subject: 'Confirmation de votre réservation - Harmonya',
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .container { max-width: 600px; margin: 0 auto; padding: 20px; }
              .header { background-color: #6B4423; color: white; padding: 20px; text-align: center; }
              .content { background-color: #F5F1E8; padding: 20px; }
              .info-row { margin: 10px 0; }
              .label { font-weight: bold; color: #6B4423; }
              .footer { text-align: center; margin-top: 20px; color: #666; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>Merci pour votre réservation !</h1>
              </div>
              <div class="content">
                <p>Bonjour ${booking.name},</p>
                <p>Nous avons bien reçu votre demande de réservation :</p>
                <div class="info-row">
                  <span class="label">Date:</span> ${dateFormatted}
                </div>
                <div class="info-row">
                  <span class="label">Heure:</span> ${booking.time}
                </div>
                <div class="info-row">
                  <span class="label">Type de massage:</span> ${booking.massageType}
                </div>
                <p style="margin-top: 20px;">
                  Nous vous contacterons bientôt par téléphone ou email pour confirmer votre rendez-vous.
                </p>
                <p>Cordialement,<br><strong>L'équipe Harmonya</strong></p>
              </div>
              <div class="footer">
                <p><strong>Harmonya</strong></p>
                <p>1 A rue de la poste<br>67400 ILLKIRCH GRAFFENSTADEN</p>
                <p>Téléphone: 06 26 14 25 89</p>
              </div>
            </div>
          </body>
          </html>
        `,
      });
      
      console.log(`Email client envoyé avec succès pour la réservation ${bookingId}`);
    } catch (error) {
      console.error(`Erreur lors de l'envoi de l'email client:`, error);
    }
    
    return null;
  });

